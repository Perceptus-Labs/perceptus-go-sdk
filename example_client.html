<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perceptus Robot Session Client</title>
  <style>
    /* ... your existing styles ... */
    #videoPreview {
      width: 320px; height: 240px;
      border: 1px solid #ccc;
      display: block; margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Perceptus Robot Session Client</h1>
    <div id="status" class="status disconnected">Disconnected</div>
    <button id="connectBtn" onclick="connect()">Connect</button>
    <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
    <button id="pingBtn" onclick="sendPing()" disabled>Send Ping</button>
    <button id="stopBtn" onclick="stopSession()" disabled>Stop Session</button>

    <h3>Live Video Preview</h3>
    <!-- hidden video to capture from camera -->
    <video id="localVideo" autoplay playsinline style="display:none;"></video>
    <!-- display server‐sent video frames -->
    <img id="videoPreview" src="" alt="Server video frame"/>

    <h3>Send Test Audio Data</h3>
    <button id="audioBtn" onclick="toggleAudio()" disabled>Start Audio Stream</button>

    <h3>Configuration</h3>
    <select id="videoFreq">
      <option value="1s">1 second</option>
      <option value="5s">5 seconds</option>
      <option value="10s" selected>10 seconds</option>
    </select>
    <button id="configBtn" onclick="sendConfig()" disabled>Update Config</button>

    <h3>Messages</h3>
    <button onclick="clearMessages()">Clear</button>
    <div id="messages"></div>
  </div>

  <script>
    let ws, pingInterval, audioRecorder, audioStream, audioTimer, videoTimer;

    function connect() {
      ws = new WebSocket('ws://localhost:8080/robot/session');
      ws.onopen = () => {
        updateStatus('Connected', true);
        // start ping
        sendPing();
        pingInterval = setInterval(sendPing, 3000);
      };
      ws.onmessage = ({ data }) => {
        const msg = JSON.parse(data);
        if (msg.type === 'video_frame') {
          document.getElementById('videoPreview').src = 'data:image/jpeg;base64,' + msg.data.image_b64;
        } else {
          addMessage(JSON.stringify(msg), 'received');
        }
      };
      ws.onclose = () => {
        updateStatus('Disconnected', false);
        clearInterval(pingInterval);
        stopMedia();
      };
      ws.onerror = err => addMessage('WS error: '+err, 'error');
      // enable controls
      document.getElementById('disconnectBtn').disabled =
      document.getElementById('pingBtn').disabled =
      document.getElementById('stopBtn').disabled =
      document.getElementById('audioBtn').disabled =
      document.getElementById('configBtn').disabled = false;
      document.getElementById('connectBtn').disabled = true;
      
      // start camera capture into hidden <video>
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          const vid = document.getElementById('localVideo');
          vid.srcObject = stream;
          vid.onloadedmetadata = () => vid.play();
          // capture a frame at the configured interval
          videoTimer = setInterval(captureAndSendFrame, parseDuration(document.getElementById('videoFreq').value));
        })
        .catch(e => addMessage('Camera error: '+e, 'error'));
    }

    function captureAndSendFrame() {
      const vid = document.getElementById('localVideo');
      if (ws.readyState !== WebSocket.OPEN) return;
      const c = document.createElement('canvas');
      c.width = vid.videoWidth; c.height = vid.videoHeight;
      c.getContext('2d').drawImage(vid, 0, 0);
      c.toBlob(blob => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const b64 = reader.result.split(',')[1];
          ws.send(JSON.stringify({ type:'video_data', data:b64, timestamp:new Date().toISOString() }));
        };
        reader.readAsDataURL(blob);
      }, 'image/jpeg');
    }

    function toggleAudio() {
      if (audioRecorder) return stopAudio();
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioStream = stream;
          audioRecorder = new MediaRecorder(stream);
          audioRecorder.ondataavailable = e => {
            const reader = new FileReader();
            reader.onloadend = () => {
              const b64 = reader.result.split(',')[1];
              if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type:'audio_data', data:b64, timestamp:new Date().toISOString() }));
              }
            };
            reader.readAsDataURL(e.data);
          };
          audioRecorder.start();
          document.getElementById('audioBtn').textContent = 'Stop Audio Stream';
        })
        .catch(e => addMessage('Mic error: '+e, 'error'));
    }

    function stopAudio() {
      audioRecorder.stop();
      audioStream.getTracks().forEach(t => t.stop());
      audioRecorder = null;
      document.getElementById('audioBtn').textContent = 'Start Audio Stream';
    }

    function stopMedia() {
      if (audioRecorder) stopAudio();
      clearInterval(videoTimer);
      const vid = document.getElementById('localVideo');
      if (vid.srcObject) vid.srcObject.getTracks().forEach(t=>t.stop());
    }

    function sendPing() {
      ws.send(JSON.stringify({ type:'ping', timestamp:new Date().toISOString() }));
    }
    function sendConfig() {
      ws.send(JSON.stringify({
        type:'config',
        data:{ video_frequency: document.getElementById('videoFreq').value },
        timestamp:new Date().toISOString()
      }));
    }
    function stopSession() {
      ws.send(JSON.stringify({ type:'stop', timestamp:new Date().toISOString() }));
    }
    function disconnect() {
      ws.close();
    }
    function updateStatus(txt, ok) {
      const st = document.getElementById('status');
      st.textContent = txt;
      st.className = 'status ' + (ok?'connected':'disconnected');
    }
    function addMessage(txt, cls='msg') {
      const m = document.createElement('div');
      m.className = 'message '+cls;
      m.innerText = `[${new Date().toLocaleTimeString()}] ${txt}`;
      document.getElementById('messages').appendChild(m);
    }
    function clearMessages() {
      document.getElementById('messages').innerHTML = '';
    }
    function parseDuration(s) {
      // "5s" → 5000
      return Number(s.replace('s','')) * 1000;
    }
  </script>
</body>
</html>
